# 事务消息

事务消息，也叫做半消息；指的是不能被 Consumer 消费的消息。

Producer 已经把消息成功发送到了 Broker，但此消息被标记为「暂不能消费」的状态，处于这种状态下的消息称为「事务消息」；需要 Producer 对消息的二次确认后，Consumer 才能消费。

#### 1. 事务消息如何做到对消费者不可见？
RocketMQ 事务消息的做法，如果消息是事务消息，将备份原消息的主题与消息队列，然后把 Topic 改为 `RMQ_SYS_TRANS_HALF_TOPIC`。由于消费组未订阅该主题，所以消费端无法消费事务消息，然后 RocketMQ 会开启一个定时任务，从 `RMQ_SYS_TRANS_HALF_TOPIC` Topic 中拉取消息进行消费，根据生产者组获取一个服务提供者，发送回查事务状态请求，根据事务状态来决定是提交或回滚消息。

#### 2. 消息回查
由于网络波动、Producer 重启等原因，导致 Producer 一直没有对事务消息进行二次确认，这时 Broker 会定时扫描事务消息，主动调用 Producer 提供的回查接口，获取事务消息的最终状态（Commit 或 Rollback）来决定是否对事务消息进行二次确认。


## 事务消息和分布式事务

RocketMQ 使用**事务消息 + 事务反查机制**来实现分布式事务。

![事务消息](/assets/images/RocketMQ/RocketMQ事务消息.png)

1. 第 1 步发送**半消息**。
2. 如果因为网络波动或者其他原因，第 4 步没有成功，半消息就无法进行下一步处理。在 RocketMQ 中使用「事务反查机制」解决，而 Kafka 通常是直接抛一个异常让用户自行解决。

还需要注意的是，在 MQ Server 和系统 B 的操作已经和系统 A 不相关了，也就是说在消息队列中的分布式事务是本地事务和存储消息到消息队列才是同一个事务。这样也就产生了事务的最终一致性，因为整个过程是异步的，每个系统只要保证它自己那一部分的事务就行了。




### 参考
- [RocketMQ - 分布式事务 - FrancisQ - 掘金](https://juejin.cn/post/6844904018322391054#heading-18)